<!DOCTYPE html>
<html>
    <head>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Anton&family=Assistant&display=swap');
        </style> 
        <link rel="stylesheet" href="styles.css">
        <title>Valorant Agent Picker</title>
    </head>
    <body class="body">
        <img src="./Resources/Agents/Astra.png" class="agent" id="agent"></img>
        <div class="test">
            <a href="#" class="text agents">AGENTS</div>
            
            <a href="maps.html" class="text maps">MAPS</div>
            <a href="teams.html" class="text teams">TEAMS</div>
        </div>  
        <div class="text-block" id="name">AGENT NAME</div>
        
        <a href="#" class="button w-button" type="button" id="spinButton">SPIN</a>
        <div class="thumbnail">
            <img src="./Resources/Thumbnails/astra.png" class="thumb" id="1"></img>
            <img src="./Resources/Thumbnails/breach.png" class="thumb" id="2"></img>
            <img src="./Resources/Thumbnails/brimstone.png" class="thumb" id="3"></img>
            <img src="./Resources/Thumbnails/chamber.png" class="center" id="4"></img>
            <img src="./Resources/Thumbnails/cypher.png" class="thumb" id="5"></img>
            <img src="./Resources/Thumbnails/fade.png" class="thumb" id="6"></img>
            <img src="./Resources/Thumbnails/jett.png" class="thumb" id="7"></img>
        </div>
        <script type="text/javascript">
          let imagesArray = [];
          let iconsArray = [];
          let agents = [];
          let names = [];
          
          async function fetchAndPreloadImages() {
            try {
              const response = await fetch('https://valorant-api.com/v1/agents');
              const json = await response.json();

              for (const agent of json.data) {
                  if (agent.isPlayableCharacter) {
                    const iconImg = new Image();
                    iconImg.src = agent.displayIcon;
                    
                    const portraitImg = new Image();
                    portraitImg.src = agent.fullPortrait;

                    const combinedCanvas = document.createElement('canvas');
                    const ctx = combinedCanvas.getContext('2d');

                    portraitImg.onload = () => {
                        iconImg.onload = () => {
                            combinedCanvas.width = portraitImg.width + iconImg.width;
                            combinedCanvas.height = Math.max(portraitImg.height, iconImg.height);
                            ctx.drawImage(portraitImg, 0, 0);
                            ctx.drawImage(iconImg, portraitImg.width, 0);
                        };
                    };

                    imagesArray.push(portraitImg);
                    iconsArray.push(iconImg);
                    names.push(agent.displayName);
                    agents.push(agent);
                  }
              }

              console.log('Images preloaded')
            } catch (error) {
              console.error('Error fetching or preloading images: ', error);
            }
          }

          window.addEventListener('DOMContentLoaded', (event) => {
            const spinButton = document.getElementById('spinButton');

            spinButton.addEventListener('click', () => {
              function inc(lookup_table, elem){
                //Loops all 6 elems
                for (let i = 0; i < 7; i++) {
                    if (lookup_table[i] == iconsArray.length - 1) {
                        lookup_table[i] = 0; //Increment the stored index of the current element
                        elem[i].src = iconsArray[0].src
                    } else {
                        lookup_table[i] += 1; //Increment the stored index of the current element
                        elem[i].src = iconsArray[lookup_table[i]].src
                    }
                    if (i == 3) {
                        document.getElementById("agent").src = imagesArray[lookup_table[i]].src;
                        document.getElementById("name").textContent = names[lookup_table[i]].toUpperCase();
                    }
                }
              }

              var time = 100;
              var elem = [];
              elem[0] = document.getElementById("1");
              elem[1] = document.getElementById("2");
              elem[2] = document.getElementById("3");
              elem[3] = document.getElementById("4");
              elem[4] = document.getElementById("5");
              elem[5] = document.getElementById("6");
              elem[6] = document.getElementById("7");
              var lookup_table = new Array(0, 1, 2, 3, 4, 5, 6);

              const rand_index = Math.floor(Math.random() * imagesArray.length);
              var operations = agents.length;
              var curr_index = lookup_table[3];
              while (curr_index != rand_index){
                  //Loop to beginning of array
                  if(curr_index == agents.length - 1){
                      curr_index = 0;
                      operations++;
                  } else {
                      curr_index++;
                      operations++;
                  }
                  
              }
              var frame;
              var time = 1; //miliseconds between operations
              var count = 0;
              frame = setInterval(clock, 100)
              function clock() {
                  setTimeout(function inner() {
                      if (count < operations) {
                          inc(lookup_table, elem);
                          time = (time ** 2);
                          count++;
                      } else {
                          clearInterval(frame);
                      }
                  }, time);
              }
          })
        })
        fetchAndPreloadImages();
      </script>
    </body>
</html>
