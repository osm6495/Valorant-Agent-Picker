<!DOCTYPE html>
<html id="site">
    <head>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Anton&family=Assistant&display=swap');
        </style> 
        <link rel="stylesheet" href="maps.css">
        <title>Valorant Agent Picker</title>
    </head>
    <body class="body">
        <div class="test">
            <a href="index.html" class="text agents">AGENTS</a>
            <a href="#" class="text maps">MAPS</a>
            <a href="teams.html" class="text teams">TEAMS</a>
        </div>  
        <div class="text-block" id="name">ASCENT</div>
        <a href="#" class="button w-button" type="button" id="spinButton">SPIN</a>
        <script type="text/javascript">
            let imagesArray = [];
            let maps = [];
            let names = [];
            
            async function fetchAndPreloadImages() {
              try {
                const response = await fetch('https://valorant-api.com/v1/maps');
                const json = await response.json();

                for (const map of json.data) {
                    //Only current way of sorting out Deathmatch maps, hopefully new comp maps won't include this string
                    if (!map.mapUrl.includes("HURM") && map.displayName !== "Basic Training" && map.displayName !== "The Range") {
                        const img = new Image();
                        img.src = map.splash;

                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        img.onload = () => {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                        };

                        imagesArray.push(img);
                        names.push(map.displayName);
                        maps.push(map);
                    }
                }

                console.log('Images preloaded')
              } catch (error) {
                console.error('Error fetching or preloading images: ', error);
              }
            }

            window.addEventListener('DOMContentLoaded', (event) => {
              const spinButton = document.getElementById('spinButton');

              spinButton.addEventListener('click', () => {
                function inc(curr_index, images, names) {
                  document.getElementById("site").style.backgroundImage = "url(" + imagesArray[curr_index].src + ")";
                  document.getElementById("name").textContent = names[curr_index].toUpperCase();
                }

                var rand_index = Math.floor(Math.random() * imagesArray.length);

                var operations = 16;
                var curr_img = document.getElementById("site").style.backgroundImage.substring(5, document.getElementById("site").style.backgroundImage.length - 2);
                if (curr_img == "") {
                    var curr_index = 0;
                    inc(0, imagesArray, names);
                } else {
                    var curr_index = imagesArray.indexOf(curr_img)
                }
                while (curr_index != rand_index){
                    //Loop to beginning of array
                    if(curr_index == imagesArray.length - 1){
                        curr_index = 0;
                        operations++;
                    } else {
                        curr_index++;
                        operations++;
                    }
                    
                }
                var frame;
                var time = 1; //miliseconds between operations
                var count = 0;
                curr_index = imagesArray.indexOf(curr_img);

                frame = setInterval(frame, 100)
                function frame() {
                    setTimeout(function inner() {
                        if (count < operations) {
                            if(curr_index == imagesArray.length - 1) {
                                curr_index = 0;
                            } else {
                                curr_index++;
                            }
                            inc(curr_index, imagesArray, names);
                            time = (time ** 2);
                            count++;
                        } else {
                            clearInterval(frame);
                        }
                    }, time);
                }

              })
            })

            fetchAndPreloadImages();
        </script>
    </body>
</html>
